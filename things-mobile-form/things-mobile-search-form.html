<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->
<link rel="import" href="../../polymer/polymer.html">

<link rel="import" href="../../paper-material/paper-material.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../paper-fab/paper-fab.html">
<link rel="import" href="../../iron-collapse/iron-collapse.html">
<link rel="import" href="../../iron-form/iron-form.html">

<link rel="import" href="../things-field-pages/things-field-pages.html">

<dom-module id="things-mobile-search-form">
  <template>
    <style>
      :host {
        display: block;
        background-color:var(--things-whitegrey-background-color);
        border-bottom:1px solid rgba(0,0,0,.1);
      }

      form {
        @apply(--things-default-padding);
        padding-bottom:5px;

      }
      paper-fab {
        @apply(--things-search-fab);
      }
      paper-icon-button{
        width:20px;height:20px;
        padding:0;
        opacity: .5;
      }
    </style>

    <paper-material elevation="0" class="layout horizontal flex" on-keypress="handleKeyPress">
      <paper-icon-button icon="[[arrowIcon]]" on-tap="toggleSearchConditions"></paper-icon-button>

      <iron-collapse id="content" class="flex" opened>
        <form is="iron-form"
          id="mobileSearchForm"
          action="[[action]]"
          method="GET"
          content-type="[[contentType]]"
          last-response ="{{lastResponse}}"
          with-credentials="[[withCredentials]]">

          <things-field-pages
            id="search-pager"
            fields="[[formFields]]">
          </things-field-pages>
          <paper-fab icon="search" title="search" on-tap="_onSearchFormTap"></paper-fab>
        </form>
      </iron-collapse>
    </paper-material>
  </template>

  <script>

    Polymer({

      is: 'things-mobile-search-form',

      properties: {
        /**
         * Toolbar에 표시할 화면 타이틀
         * *******
         * @type {String}
         */
        title: {
          type: String
        },

        /**
         * 검색 조건 Folding 아이콘
         * *******
         * @type {String}
         */
        arrowIcon: {
          type: String,
          value: 'icons:arrow-drop-down'
        },

        actionUrl: {
          type: String,
          observer: 'actionUrlChanged'
        },

        page: {
          type: Number,
          value: 1
        },

        limit: {
          type: Number,
          value: 50
        }
      },

      listeners : {
        'iron-form-presubmit' :'handleBeforeSubmit',
        'iron-form-response' :'_successResponseHandler',
        'iron-form-error' : '_errorResponseHandler'
      },

      behaviors: [
        Things.FormBehavior,
        Things.SearchFormBehavior,
        // Things.MenuContentBehavior,
        Things.SpinnerBehavior,
        Things.MsgBoxBehavior
      ],

      /**
       * 검색 조건을 접고 펴는 액션
       *******
       * @param {Object} event
       */
      toggleSearchConditions : function(event) {
        this.$['content'].toggle();
        if(this.$['content'].opened) {
          this.arrowIcon = 'icons:arrow-drop-up';
        } else {
          this.arrowIcon = 'icons:arrow-drop-down';
        }
      },

      /**
       * 리소스 폼이 이미 구성되었는지 여부
       * ******
       */
      isFormConfigured: function() {
        return this.formConfigured;
      },

      /**
       * 검색 폼 화면을 구성. formFields 정보로 동적으로 폼 하위 엘리먼트를 생성하여 폼을 구성한다.
       * *******
       */
      reconfigureMyForm: function() {
        // this.fire('things-search-form-configured', this.formFields);  // Things.MenuContentBehavior
        
        this.active = true;
      },

      /**
       * 모든 Form Element를 리턴
       * ******
       */
      getFormElements: function(formElements) {
        var element = this.$$('things-field-pages');

        var childNodes = element.childNodes;
        var childElements = this.getChildElements(childNodes);
        return childElements;
      },

      getChildElements: function(nodes) {
        var childElements = [];

        var me = this;
        nodes.forEach(function(e, idx) {
          var childNodes = e.childNodes;
          if(!childNodes || childNodes.length == 0 
            || e.nodeName === 'PAPER-INPUT') {
            childElements.push(e);
          } else {
            childElements = childElements.concat(me.getChildElements(childNodes));
          }
        });

        return childElements;
      },

      actionUrlChanged: function(actionUrl) {
        if (actionUrl)
          this.submitMyForm();
      },

      /**
       * Submit Form. 검색 실행
       * *******
       */
      submitMyForm: function() {
        var evt = this.fire('things-form-search', this, { cancelable: true });
        if(!evt.defaultPrevented) {
          // 1. 초기 파라미터가 있다면 설정해준다.
          this._bindInitialParams();
          // 2. Start Spinner
          this.startSpinner();
          // 3. Submit
          this.getMyForm().submit();
        }
      },

      /**
       * 조회 버튼 클릭시 current page를 1로 리셋
       *
       * @param {Object} e 버튼 클릭 이벤트
       */
      _onSearchFormTap: function(e) {
        if(this.page > 1) {
          this.page = 1;
        } else {
          this.submitMyForm();
        }
      },

      /**
       * en-us
       *
       * Successful response handler After form submits.
       * this fires a 'things-form-submit-success' in this function
       ******
       *
       * ko-kr
       *
       * form submit후 성공적인 응답 핸들러. 이 함수에서 'things-form-submit-success'를 발생.
       ******
       * @param {Object} event Successful response event
       */
      _successResponseHandler: function(event) {
        this.stopSpinner();
        this.lastResponse = event.detail.xhr.response;
        // this.handleSuccessResponse(this.lastResponse);
      },

      /**
       * en-us
       *
       * Error response handler After form submits.
       * this fires a 'things-form-submit-error' in this function
       ******
       *
       * ko-kr
       *
       * 오류 응답 핸들러 form이 submit된 후, 이 함수에 'things-form-submit-error'를 발생.
       *
       * @param {Object} event Error response event
       */
      _errorResponseHandler: function(event) {
        this.stopSpinner();

        var response = event.detail.request.xhr.response;
        if(response && response.status == 401) {
          this.handleUnauthorized();

        } else {
          if(response) {
            this.openResponseError(response);
          } else {
            response = event.detail.request;
            this.openUnkownError(response);
          }
        }

        this.handleErrorResponse(response);
      }
    });
  </script>
</dom-module>
