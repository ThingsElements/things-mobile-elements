<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->
<link rel="import" href="../../polymer/polymer.html">

<link rel="import" href="../../things-ajax/things-ajax.html">

<link rel="import" href="../things-mobile-form/things-mobile-search-form.html">
<link rel="import" href="../things-mobile-list/things-mobile-list.html">

<!--
사용자가 Entity 기반으로 설정된 특정 리소스에 대해서 선택할 수 있도록 제공하는 Selector
-->

<dom-module id="things-mobile-selector-content">
	<template>
		<style>
			:host {
				display: block;
				@apply(--layout-vertical);
				@apply(--layout-flex);
			}

			things-resource-grid {
				@apply(--layout-flex);
			}
		</style>
	
		<things-i18n-msg msg="{{labelName}}" msgid="label.name" auto hidden>Comment</things-i18n-msg>
		<things-i18n-msg msg="{{labelDesc}}" msgid="label.description" auto hidden>Comment</things-i18n-msg>

		<template is="dom-if" if=[[entityName]]>
			<things-mobile-search-form
				id="content-search-form"
				form-fields="[[searchFormFields]]"
				select-fields="[[selectFields]]"
				sort-fields="[[sortFields]]"
				action-url="[[actionUrl]]"
				page="{{page}}"
				limit="[[limit]]"
				initial-params="{{initialParams}}"
				last-response="{{lastResponse}}">
			</things-mobile-search-form>
		</template>

		<!-- <things-resource-grid
			id="grid"
			model="[[gridModel]]"
			columns="[[gridColumns]]"
			config="[[gridConfig]]"
			current-page="{{page}}"
			limit="{{limit}}"
			data="[[items]]"
			total-count="[[itemCount]]"
			fixed-column-count="0"
			paginatable>
		</things-resource-grid> -->

		<things-mobile-list
			id="list"
			limit="{{limit}}"
			items="[[items]]"
			class="flex">
		</things-mobile-list>

	    <things-ajax
			id="entity-content"
			resource-url="[[resourceUrl]]"
			method="GET"
			page="[[page]]"
			limit="[[limit]]"
			select-fields="[[selectFields]]"
			query-fields="[[queryFields]]"
			sort-fields="[[sortFields]]"
			last-response="{{entityMeta}}">
		</things-ajax>

	    <!-- <things-ajax
			id="code-content"
			page="[[page]]"
			limit="[[limit]]"
			resource-url="[[resourceUrl]]"
			resource-action="show_by_name"
			params="[[codeParams]]"
			last-response="{{lastResponse}}">
	    </things-ajax> -->
	</template>

	<script>
		Polymer({
			is: 'things-mobile-selector-content',

			behaviors: [
				// Things.MobileSelectorContentBehavior,
			],

			properties: {
				/**
				 * Resource Selector 타이틀
				 * ******
				 * @type {String}
				 */
				title: {
					type: String
				},

				page: {
					type: Number,
					value: 1
				},

				limit: {
					type: Number,
					value: 100
				},

				contentType: {
					type: String,
					value: 'ENTITY'	// ENTITY, CODE
				},

				codeName: {
					type: String
				},

				entityName: {
					type: String
				},

				/**
				 * 조회 결과
				 * ******
				 * @type {Object}
				 */
				lastResponse: {
					type: Object,
					observer: '_responseChanged'
				},

				entityMeta: {
					type: Object,
					observer: '_entityMetaChanged'
				},

				/**
				 * 조회 결과 리스트 데이터 프로퍼티 명
				 * ******
				 * @type {String}
				 */
				itemsProp: {
					type: String,
					value: 'items'
				},

				/**
				 * 조회 결과 리스트 Total Count 프로퍼티 명
				 * ******
				 * @type {String}
				 */
				totalProp: {
					type: String,
					value: 'total'
				},

				/**
				 * 조회 결과 리스트 데이터
				 * ******
				 * @type {Array}
				 */
				items: {
					type: Array
				},

				/**
				 * 조회 결과 레코드 수
				 * ******
				 * @type {Number}
				 */
				itemCount: {
					type: Number
				},

				/**
				 * Resource Selector 창이 실행되면서 바로 반영되어야 할 파라미터들을 지정한다.
				 * Resource Selector가 실행된 후 바로 서비스 호출을 하게 되는데 이 때 initialParams가 서비스 호출 파라미터에 반영된다.
				 * Format : {Parameter Name1}:{Parameter Value1},{Parameter Name2}:{Parameter Value2},...
				 * *******
				 * @type {String}
				 */
				initialParams: {
					type: String
				},

				searchFields: {
					type: Array
				},

				/**
				 * ResourceSelector에서 선택한 값을 기본값(id, title필드 값) 외에 ownerResource의 다른 필드에 설정하고자 할 때 사용. fromField1=toField1,fromField2=toField2... ','구분자로 구분한다.
				 * ******
				 * @type {String}
				 */
				bindFields: {
					type: String
				},

				/**
				 * Resource Selector를 호출한 Element
				 * ******
				 * @type {Object}
				 */
				ownerElement: {
					type: Object
				},

				/**
				 * Resource Selector Dialog를 띄운 Element의 (폼 필드 명 혹은 그리드 필드 명)Field 명
				 * ******
				 * @type {String}
				 */
				ownerField: {
					type: String
				},

				/**
				 * OwnerElement가 소속된 Container - Form or Grid
				 * initialParams로 검색 조건을 dynamic하게 설정하거나 bindFields로 ResourceSelectorDialog에서 선택한 Record에 다른 값들을 자동으로 설정하고자 할 때 필요하다.
				 * ******
				 * @type {Object}
				 */
				ownerContainer: {
					type: Object
				},

				/**
				 * ownerType이 Grid일 경우에만 해당
				 * ResourceSelector를 호출한 그리드의 선택된 Row Index - 이 정보로 ResourceSelector로 선택한 데이터를 업데이트 한다.
				 * ******
				 * @type {Number}
				 */
				parentGridRowIdx: {
					type: Number
				},

				/**
				 * 호출 측 타입 - Form or Grid
				 * ******
				 * @type {String}
				 */
				ownerType: {
					type: String
				},

				/**
				 * value로 설정될 필드명
				 * ******
				 * @type {String}
				 */
				valueField: {
					type: String
				},

				/**
				 * 화면 구성을 위해 필요한 메타 데이터를 조회하기 위한 URL <br/>
				 * entityName 즉 Entity 명이 결정되면 이 URL도 결정이 된다.
				 */
				resourceUrl: {
					type: String
				},
			},

			listeners : {
				// 'grid.things-grid-configured' : 'refreshGridData',
				// 'grid.things-grid-row-data-select' : 'selectRecord',
				'list.item-select': 'selectRecord'
			},

			observers: [
				'_entityChanged(entity)',
				'_ownerElementChanged(ownerElement)',
				// '_codeNameChanged(codeName)',
				'_entityNameChanged(entityName)',
				'_searchFieldsChanged(searchFields)'
			],

			attached: function() {
				var me = this;
				this.searchFormFields = [{
					label: me.labelName,	// FIXME
					name: 'name',
					op: 'contains',
					type: 'text'
				}, {
					label: me.labelDesc,	// FIXME
					name: 'description',
					op: 'contains',
					type: 'text'
				}];
			},

			/**
			 * 엔티티 메타데이터 변경시
			 *********
			 * @param {Object} entity
			 */
			_entityChanged: function(entity) {
				if(entity) {
					this.title = entity.title;
				}
			},

			/**
			 * ownerElement가 변경되었을 경우
			 *********
			 * @param {Object} ownerElement
			 */
			_ownerElementChanged: function(ownerElement) {
				var elementName = ownerElement.localName;
				if(!elementName) {
					this.ownerType = 'Grid';
				} else {
					this.ownerType = 'Form';
				}
			},

			_searchFieldsChanged: function(searchFields) {
				if (!searchFields) {
					return;
				}

				this.searchFormFields = this.searchFormFields.concat(searchFields);
			},

			// _codeNameChanged: function(codeName) {
			// 	if (!codeName || this.items) return;

			// 	this.codeParams = { name: codeName };
			// 	this.resourceUrl = 'common_codes/show_by_name';
			// 	this.$['code-content'].generateRequest();
			// },

			_entityNameChanged: function(entityName) {
				if (!entityName) return;

				this.resourceUrl = 'entities/' + entityName + '/meta';
				this.$['entity-content'].generateRequest();
			},

			_entityMetaChanged: function(entityMeta) {
				this.actionUrl = entityMeta.search_url;
			},

			/**
			 * 조회 데이터 변경시
			 *********
			 * @param {Object} lastResponse
			 */
			_responseChanged: function(lastResponse) {
				this.items = lastResponse[this.itemsProp] ? lastResponse[this.itemsProp] : lastResponse;

				this.itemCount = lastResponse[this.totalProp] ? lastResponse[this.totalProp] : lastResponse.length;
			},

			// /**
			//  * entityName, resrouceType에 따라 resourceUrl을 추출
			//  *
			//  * @param {Object} response
			//  */
			// _urlResponseHandler: function(response) {
			// 	if(this.resourceType.indexOf('ENTITY') >= 0) {
			// 		this.entityUrl = response.detail.items[0].search_url;
			// 	} else if (this.resourceType.indexOf('Menu') >= 0) {
			// 		this.entityUrl = response.detail.items[0].resource_url;
			// 	}
			// },

			/**
			 * ID Field를 리턴한다.
			 * *******
			 * @return {String} id 값으로 사용될 필드명
			 */
			getIdField: function() {
				return (this.entity && this.entity.id_field) ? this.entity.id_field : 'id';
			},

			/**
			 * Title Field를 리턴한다.
			 * ********
			 * @return {String} title 값으로 사용될 필드명
			 */
			getTitleField: function() {
				return (this.entity && this.entity.title_field) ? this.entity.title_field : 'name';
			},

			/**
			 * Description Field를 리턴한다.
			 * ********
			 * @return {String} description 값으로 사용될 필드명
			 */
			getDescriptionField: function() {
				return (this.entity && this.entity.description_field) ? this.entity.description_field : 'description';
			},

			/**
			 * Owner Data를 찾아 리턴
			 * ********
			 */
			findOwnerData: function() {
				if(this.ownerType == 'Form') {
					if(this.ownerContainer) {
						return this.ownerContainer.serialize ?
									 this.ownerContainer.serialize() :
									 (this.ownerContainer.serializeMyForm ? this.ownerContainer.serializeMyForm() : null);
					} else {
						return null;
					}

				} else if(this.ownerType == 'Grid') {
					var row = this.ownerElement.focusedRow();
					return (row && row.dataIndex() >= 0) ? row.getRowObject() : null;

				} else {
					return null;
				}
			},

			/**
			 * Selector Grid에서 데이터 선택시
			 *********
			 * @param {Object} event
			 */
			selectRecord: function(event) {
				if(this.ownerType == 'Form') {
					this._selectRecordByForm(event);

				} else if(this.ownerType == 'Grid') {
					this._selectRecordByGrid(event);
				}
			},

			/**
			 * Owner가 Form인 경우에 데이터 선택시
			 *********
			 * @param {Object} event
			 */
			_selectRecordByForm: function(event) {
				var selectedResource = event.detail;
				var ownerData = this.findOwnerData();

				// console.log(selectedResource);

				// resource format selector인 경우 Object 값으로 설정한다.
				if(this.ownerElement.localName == 'things-resource-format-selector') {
					this.ownerElement.setObjValue(selectedResource);

				// Container에서 필요한 대표 컬럼 및 선택한 값을 설정한다.
				} else {
					var resourceIdField	= this.ownerElement.resourceIdField;
					this.ownerElement.resourceIdField = (resourceIdField) ? resourceIdField : this.getIdField();

					var resourceTitleField = this.ownerElement.resourceTitleField;
					this.ownerElement.resourceTitleField = (resourceTitleField) ? resourceTitleField : this.getTitleField();

					var idValue = selectedResource[this.getIdField()];
					var displayValue = selectedResource[this.getTitleField()];
					this.ownerElement.setResourceValue(idValue, displayValue, selectedResource);
				}

				this._bindObjectFields(selectedResource, ownerData);
				this.closeResourceSelectorDialog();
			},

			/**
			 * bindFields 정보를 기반으로 targetData에 sourceData의 데이터를 설정한다.
			 *********
			 * @param {Object} sourceData
			 * @param {Object} targetData
			 */
			_bindObjectFields: function(sourceData, targetData) {
				if(this.bindFields) {
					var binders = this.bindFields.split(',');
					for(var i = 0 ; i < binders.length ; i++) {
						var binder = binders[i];
						var fromField = binder, toField = binder;

						if(binder.indexOf('=') > 0) {
							var binderArr = binder.split('=');
							toField = binderArr[0], fromField = binderArr[1];
						}

						targetData[toField] = sourceData[fromField];
					}
				}

				if(this.ownerType == 'Form' && this.bindFields) {
					this.ownerElement.setParentFormData(targetData);
				}
			},

			/**
			 * Owner가 Grid인 경우에 데이터 선택시
			 *********
			 * @param {Object} event
			 */
			_selectRecordByGrid: function(event) {
				var selectedResource = event.detail;

				// 메뉴에서 설정한 idField와 titleField로 event.detail내의 값을 추출한 뒤 object로 구성하여 그리드의 row 데이터 중에 업데이트 할 필드로 업데이트한다.
				var parentGrid = this.ownerElement;
				var idField = this.getIdField();
				var titleField = this.getTitleField();
				var descriptionField = this.getDescriptionField();
				var row = parentGrid.focusedRow();
				var dataSet = parentGrid.dataSource();

				if(row && row.dataIndex() >= 0) {
					var rowObj = row.getRowObject();
					var objToChange = rowObj[this.ownerField];

					if(this.valueField) {
						objToChange = this._getSingleValueOfSelectedRecord(selectedResource, this.valueField);
					} else {
						objToChange = this._getResourceValueOfSelectedRecord(selectedResource, objToChange, idField, titleField, descriptionField);
					}

					// Grid의 ownerField 데이터 변경
					rowObj[this.ownerField] = objToChange;

					// Bind Fields 정보로 Grid 데이터 변경
					this._bindObjectFields(selectedResource, rowObj);
					this.fire('things-resource-selector-selected', { rowObj: rowObj, resource : selectedResource } );

					// 부모 그리드 Refresh
					dataSet.updateRow(this.parentGridRowIdx, rowObj);
					parentGrid.refreshView();

					// Close Dialog
					this.closeResourceSelectorDialog();
				}
			},

			/**
			 * 사용자가 선택한 레코드에서 Resource Value (Object)를 리턴
			 *********
			 * @param {Object} selectedResource 현재 선택한 레코드 값
			 * @param {Object} objToChange Owner Grid의 선택된 레코드의 필드 Object 값  
			 * @param {String} idField id 값으로 사용할 필드명
			 * @param {String} titleField title 값으로 사용할 필드명
			 * @param {String} descriptionField description 값으로 사용할 필드명
			 * @return {Object} 선택된 레코드의 값
			 */
			_getResourceValueOfSelectedRecord: function(selectedResource, objToChange, idField, titleField, descriptionField) {
				if(typeof(objToChange) === 'undefined' || objToChange === null) {
					objToChange = {};
				}

				if(typeof(objToChange) == 'object') {
					objToChange[idField] = selectedResource[idField];
					objToChange[titleField] = selectedResource[titleField];
					objToChange[descriptionField] = selectedResource[descriptionField];

				} else if(typeof(objToChange) == 'string') {
					objToChange = selectedResource[titleField];

				} else if(typeof(objToChange) == 'number') {
					objToChange = selectedResource[idField];
				}

				return objToChange;
			},

			/**
			 * 사용자가 선택한 레코드 중에 valueField에 해당하는 값을 리턴
			 *********
			 * @param {Object} selectedResource
			 * @param {String} valueField
			 * @return {String} 선택된 레코드의 valueField에 해당하는 값
			 */
			_getSingleValueOfSelectedRecord: function(selectedResource, valueField) {
				return selectedResource[valueField];
			},

			/**
			 * Close Resource Selector Dialog
			 * *******
			 */
			closeResourceSelectorDialog: function() {
				this.fire('things-dialog-close');
			},

			/**
			 * Resource Selector의 Container 폼을 찾아 리턴
			 * ********
			 * @param {Object} element
			 */
			findOwnerDialog: function(element) {
				if(!element.parentElement) {
					return null;
				} else {
					if(element.parentElement.localName == 'things-resource-dialog') {
						return element.parentElement;
					} else {
						return this.findOwnerDialog(element.parentElement);
					}
				}
			}
		});
	</script>
</dom-module>
